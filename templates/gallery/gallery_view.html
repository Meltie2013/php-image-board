{include file="global/header.html"}

    <main class="gallery-container-view">
        <div class="gallery-item-view">
            <div class="gallery-left-side">
                <div class="gallery-details-view">
                    <section>
                        {if $is_logged_in}
                        <div class="gallery-toolbar">
                            <button title="Edit Image">
                                <i class="fa-solid fa-pen-to-square"></i>
                            </button>

                            <button title="Image Views">
                                <i class="fa-solid fa-eye"></i>
                                {$img_views}
                            </button>
        
                            {if $img_has_favorited}
                            <button title="Already Favorited">
                                <i class="fa-solid fa-star"></i>
                                {$img_favorites}
                            </button>
                            {else}
                            <form method="POST" action="/image/{$img_hash}/favorite">
                                <input type="hidden" name="csrf_token" value="{$csrf_token}">
                                <button type="submit" title="Add Favorite">
                                    <i class="fa-solid fa-star"></i>
                                    {$img_favorites}
                                </button>
                            </form>
                            {/if}

                            {if $img_has_voted}
                            <button title="Already Upvoted">
                                <i class="fa-solid fa-thumbs-up"></i>
                                {$img_votes}
                            </button>
                            {else}
                            <form method="POST" action="/image/{$img_hash}/upvote">
                                <input type="hidden" name="csrf_token" value="{$csrf_token}">
                                <button type="submit" title="Up Vote">
                                    <i class="fa-solid fa-thumbs-up"></i>
                                    {$img_votes}
                                </button>
                            </form>
                            {/if}

                            <button title="Report Image">
                                <i class="fa-solid fa-flag"></i>
                            </button>
                        </div>
                        {else}
                        <div class="gallery-toolbar">
                            <button title="Image Views">
                                <i class="fa-solid fa-eye"></i>
                                {$img_views}
                            </button>

                            <button title="Login to Favorite">
                                <i class="fa-solid fa-star"></i>
                                {$img_favorites}
                            </button>

                            <button title="Login to Upvote">
                                <i class="fa-solid fa-thumbs-up"></i>
                                {$img_votes}
                            </button>
                        </div>
                        {/if}
                    </section>

                    <section>
                        <h3>Details</h3>
                        <ul>
                            <li><strong>Image ID:</strong> {$img_hash}</li>
                            <li><strong>File Type:</strong> {$img_mime_type}</li>
                            <li><strong>Dimensions:</strong> {$img_width} Ã— {$img_height} px</li>
                            <li><strong>File Size:</strong> {$img_size}</li>
                            <li><strong>Image Status:</strong> {$img_approved_status}</li>
                            <li><strong>Uploaded By:</strong> {$img_username}</li>
                            <li><strong>Upload Date:</strong> {$img_created_at}</li>
                        </ul>
                    </section>

                    <section>
                        <h3>Hashes</h3>
                        <ul>
                            <li>
                                <strong>MD5 Hash:</strong>
                                <small>{$img_md5}</small>
                            </li>

                            <li>
                                <strong>SHA-1 Hash:</strong>
                                <small>{$img_sha1}</small>
                            </li>
                        </ul>
                    </section>

                    <section>
                        <h3>Description</h3>
                        <p>{$img_description}</p>
                    </section>

                    <section>
                        <h5><a href="/image/original/{$img_hash}">View Image</a></h5>
                        <h5><a href="#" class="js-open-comments">Comments ({$img_comment_count})</a></h5>
                    </section>

                    <section>
                        <h3>Tags</h3>

                    </section>
                </div>
            </div>

            <div class="gallery-image-wrapper">
                {if $img_age_sensitive || $img_reject_reason}
                <div class="alert {$alert_color}">
                    <b>{$alert_tag}</b> {$alert_message} <a href="#">Learn more</a>
                </div>
                {/if}
                <img src="/image/original/{$img_hash}" class="gallery-image-view">
            </div>
        </div>
    </main>

    <div class="comments-modal-overlay js-comments-overlay" aria-hidden="true">
        <div class="comments-modal" role="dialog" aria-modal="true" aria-label="Image Comments">
            <div class="comments-modal-header">
                <h3>Total Comments ({$img_comment_count})</h3>
    
                <button type="button" class="comments-modal-close js-close-comments" title="Close">
                    <i class="fa-solid fa-xmark"></i>
                </button>
            </div>

            {if $is_logged_in}
            <form method="POST" action="/image/{$img_hash}/comment" class="comments-modal-form">
                <input type="hidden" name="csrf_token" value="{$csrf_token}">
                <textarea name="comment_body" rows="3" placeholder="Write a comment..." required></textarea>
                <button type="submit">Post Comment</button>
            </form>

            <div class="comments-modal-body">
                {if $img_comment_count > 0}
                <h3>User Comments</h3>

                <div class="gallery-comments-list">
                    <small>Showing <u>{$displayed_comments}</u> comment(s) per page.</small>
                    {foreach $comment_rows as list($comment_username, $comment_created_at, $comment_body)}
                    <div class="gallery-comment">
                        <div class="gallery-comment-meta">
                            <b>{ucfirst($comment_username)}</b>
                            <span>{$comment_created_at}</span>
                        </div>

                        <div class="gallery-comment-body">
                            <small>{$comment_body}</small>
                        </div>
                    </div>
                    {/foreach}
                </div>

                {if $comments_total_pages > 1}
                <div class="comments-pagination">
                    {if $comments_has_prev}
                    <a class="comments-page-btn" href="/image/{$img_hash}?cpage={$comments_prev_page}&show_comments=1">Prev</a>
                    {else}
                    <span class="comments-page-btn is-disabled">Prev</span>
                    {/if}

                    <span class="comments-page-info">Page {$comments_page} of {$comments_total_pages}</span>

                    {if $comments_has_next}
                    <a class="comments-page-btn" href="/image/{$img_hash}?cpage={$comments_next_page}&show_comments=1">Next</a>
                    {else}
                    <span class="comments-page-btn is-disabled">Next</span>
                    {/if}
                </div>
                {/if}

                {else}
                <div class="gallery-comments-list">
                    <small>Be the first to comment on this image!</small>
                </div>
                {/if}
            </div>
            {else}
            <div class="comments-modal-footer">
                <small>Greatings guest! To view or post comments, please <a href="/user/register/">register</a> or <a href="/user/login">login</a>.</small>
            </div>
            {/if}

        </div>
    </div>
    
    <script>
        (function () {
            const openBtn = document.querySelector('.js-open-comments');
            const overlay = document.querySelector('.js-comments-overlay');
            const closeBtn = document.querySelector('.js-close-comments');
        
            if (!openBtn || !overlay || !closeBtn) return;
        
            function openModal(e) {
                if (e) e.preventDefault();
                overlay.classList.add('is-open');
                overlay.setAttribute('aria-hidden', 'false');
                document.body.style.overflow = 'hidden';
            }
        
            function closeModal() {
                overlay.classList.remove('is-open');
                overlay.setAttribute('aria-hidden', 'true');
                document.body.style.overflow = '';
            }
        
            openBtn.addEventListener('click', openModal);
            closeBtn.addEventListener('click', closeModal);

            // Auto-open modal when pagination links are used
            const params = new URLSearchParams(window.location.search);
            if (params.get('show_comments') === '1')
            {
                openModal();
            }
        
            overlay.addEventListener('click', function (e) {
                if (e.target === overlay) closeModal();
            });
        
            document.addEventListener('keydown', function (e) {
                if (e.key === 'Escape') closeModal();
            });
        })();
        </script>        

{include file="global/footer.html"}
